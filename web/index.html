<!DOCTYPE html>
<html lang="en">
<head>
	<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>The Siege of GitHub: Capture the Flag Rankings</title>
	<link rel="stylesheet" href="./styles.css">
</head>
<body>
	<div class="side-menu" id="sideMenu">
		<div class="side-menu-header">
			<span style="font-family: 'Press Start 2P', cursive, sans-serif; font-size: 0.8rem; color: #155799;">Flags</span>
			<button id="closeMenuBtn" class="close-menu-btn" title="Close">&times;</button>
		</div>
		<div class="flag-menu" id="flagMenu">
			<!-- Flag buttons will be injected here -->
		</div>
	</div>
	<button id="burgerBtn" class="burger-btn" title="Show Flags">
		<span></span>
		<span></span>
		<span></span>
	</button>
	<div class="container">
		<h1>The Siege of GitHub: Capture the Flag Rankings</h1>
		<table>
			<thead>
				<tr>
					<th>Rank</th>
					<th>Participant</th>
					<th>Time (minutes)</th>
				</tr>
			</thead>
			<tbody id="rankingTable">
				<!-- Ranking rows will be injected here -->
			</tbody>
		</table>
		<div style="text-align: center; margin-top: 24px;">
			<a href="https://github.com/vitoc/siege" target="_blank" style="color: #fff; text-decoration: none; font-family: 'Press Start 2P', cursive, sans-serif; font-size: 0.7rem; background: rgba(255,255,255,0.25); padding: 12px 24px; border-radius: 8px; display: inline-block; box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.15); transition: background 0.2s, box-shadow 0.2s;">
				GitHub Repo and More Info
			</a>
		</div>
	</div>
	<script>
		// 12 Flags from README.md
		const flags = [
			{ name: 'Introduction to GitHub', url: 'https://github.com/skills-dev/introduction-to-github' },
			{ name: 'GitHub Pages', url: 'https://github.com/skills-dev/github-pages' },
			{ name: 'Intro to Repository Management', url: 'https://github.com/skills/introduction-to-repository-management' },
			{ name: 'Customize your GitHub Copilot experience', url: 'https://github.com/skills/customize-your-github-copilot-experience' },
			{ name: 'Integrate MCP with GitHub Copilot', url: 'https://github.com/skills/integrate-mcp-with-copilot' },
			{ name: 'Modernize your legacy code with GitHub Copilot', url: 'https://github.com/skills/modernize-your-legacy-code-with-github-copilot' },
			{ name: 'Scale institutional knowledge with GitHub Copilot Spaces', url: 'https://github.com/skills/scale-institutional-knowledge-using-copilot-spaces' },
			{ name: 'Build applications with GitHub Copilot agent mode', url: 'https://github.com/skills/build-applications-w-copilot-agent-mode' },
			{ name: 'AI in Actions', url: 'https://github.com/skills/ai-in-actions' },
			{ name: 'Secure your code supply chain', url: 'https://github.com/skills-dev/secure-repository-supply-chain' },
			{ name: 'Introduction to CodeQL', url: 'https://github.com/skills-dev/introduction-to-codeql' },
			{ name: 'Migrate Azure DevOps Repository', url: 'https://github.com/skills/migrate-ado-repository' },
		];

		// Dynamic ranking data for each flag
		const rankings = Array(flags.length).fill(null);
		const flagMenu = document.getElementById('flagMenu');
		const rankingTable = document.getElementById('rankingTable');
		const sideMenu = document.getElementById('sideMenu');
		const burgerBtn = document.getElementById('burgerBtn');
		const closeMenuBtn = document.getElementById('closeMenuBtn');
		let currentFlag = 0;

		// Side menu open/close logic
		burgerBtn.addEventListener('click', () => {
			sideMenu.classList.add('open');
			burgerBtn.style.display = 'none';
		});
		closeMenuBtn.addEventListener('click', () => {
			sideMenu.classList.remove('open');
			burgerBtn.style.display = 'flex';
		});

		// Optional: close menu when clicking outside
		document.addEventListener('click', (e) => {
			if (sideMenu.classList.contains('open')) {
				if (!sideMenu.contains(e.target) && e.target !== burgerBtn) {
					sideMenu.classList.remove('open');
					burgerBtn.style.display = 'flex';
				}
			}
		});

		// --- New: Show overall flags captured on initial table ---
		async function fetchOverallFlagsCaptured() {
			try {
				const resp = await fetch('https://raw.githubusercontent.com/vitoc/siege/refs/heads/main/flags_captured.json');
				if (!resp.ok) throw new Error('Not found');
				let data = await resp.json();
				console.log('Overall flags captured data:', data);
				// Filter out entries with missing or invalid flags_captured
				data = data.filter(entry => typeof entry.flags_captured === 'number' && !isNaN(entry.flags_captured));
				// Sort by most flags captured (descending)
				data.sort((a, b) => b.flags_captured - a.flags_captured);
				renderOverallTable(data);
			} catch (e) {
				rankingTable.innerHTML = '<tr><td colspan="3">No participant data available.</td></tr>';
			}
		}

		function renderOverallTable(data) {
			if (!Array.isArray(data) || data.length === 0) {
				rankingTable.innerHTML = '<tr><td colspan="3">No participant data available.</td></tr>';
				return;
			}
			const rows = data.map((entry, i) => {
				return `<tr><td>${i + 1}</td><td>${entry.user}</td><td>${entry.flags_captured}</td></tr>`;
			}).join('');
			rankingTable.innerHTML = rows;
		}

		// --- End new code ---

		// Keep the rest of the flag menu logic for per-flag rankings
		function getJsonFileName(flagName) {
			let base = flagName
				.toLowerCase()
				.replace(/[^a-z0-9]+/g, '-')
				.replace(/-+/g, '-')
				.replace(/^-|-$/g, '');
			return `skills-${base}.json`;
		}

		async function fetchRanking(idx) {
			const flag = flags[idx];
			const fileName = getJsonFileName(flag.name);
			const url = `https://raw.githubusercontent.com/vitoc/siege/refs/heads/main/${fileName}`;
			try {
				const resp = await fetch(url);
				if (!resp.ok) throw new Error('Not found');
				const data = await resp.json();
				if (Array.isArray(data)) {
					rankings[idx] = data
						.map((entry, i) => ({
							participant: entry.user || entry.participant || `User${i+1}`,
							score: entry.time_diff_seconds || entry.score || 0
						}))
						.sort((a, b) => a.score - b.score);
				} else {
					rankings[idx] = [];
				}
			} catch (e) {
				rankings[idx] = null;
			}
			if (idx === currentFlag) renderTable();
		}

		function renderMenu() {
			flagMenu.innerHTML = '';
			flags.forEach((flag, idx) => {
				const btn = document.createElement('button');
				btn.className = 'flag-btn' + (idx === currentFlag ? ' active' : '');
				btn.textContent = `${idx + 1}. ${flag.name}`;
				btn.onclick = () => {
					currentFlag = idx;
					renderMenu();
					if (rankings[idx] === null) fetchRanking(idx);
					else renderTable();
				};
				btn.title = flag.name;
				flagMenu.appendChild(btn);
			});
		}

		function renderTable() {
			const data = rankings[currentFlag];
			if (data === null) {
				rankingTable.innerHTML = '<tr><td colspan="3">No participants in the flag challenge yet.</td></tr>';
				return;
			}
			if (!Array.isArray(data) || data.length === 0) {
				rankingTable.innerHTML = '<tr><td colspan="3">No participants in the flag challenge yet.</td></tr>';
				return;
			}
			const rows = data.map((entry, i) => {
				const minutes = (entry.score / 60).toFixed(2);
				return `<tr><td>${i + 1}</td><td>${entry.participant}</td><td>${minutes}</td></tr>`;
			}).join('');
			rankingTable.innerHTML = rows;
		}

		// Initial render: show overall flags captured
		renderMenu();
		alert('Welcome to The Siege of GitHub: Capture the Flag Rankings!\n\nBy default, the rankings table shows overall flags captured by participants. Use the "Show Flags" button to open the side menu and select individual flags to see their specific rankings based on completion time.\n\nEnjoy competing and climbing the leaderboard!');
		fetchOverallFlagsCaptured();
	</script>
</body>
</html>
